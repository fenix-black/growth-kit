generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String   // bcrypt hash
  name      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Organization relationship
  organizations       Organization[]
  sentInvitations     OrganizationInvitation[] @relation("SentInvitations")

  @@map("users")
}

model Organization {
  id        String   @id @default(cuid())
  name      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Credits
  creditBalance Int @default(0)
  
  // Relationships
  users             User[]
  apps              App[]
  invitations       OrganizationInvitation[]
  creditTransactions OrganizationCreditTransaction[]

  @@map("organizations")
}

model OrganizationInvitation {
  id             String       @id @default(cuid())
  organizationId String
  email          String
  invitedBy      String
  inviteToken    String       @unique
  expiresAt      DateTime
  status         String       @default("PENDING") // PENDING, ACCEPTED, EXPIRED, REVOKED
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  inviter        User         @relation("SentInvitations", fields: [invitedBy], references: [id])
  
  @@unique([organizationId, email])
  @@index([inviteToken])
  @@index([email])
  @@index([status])
  @@map("organization_invitations")
}

model Tenant {
  id        String   @id @default(cuid())
  name      String
  domain    String?  @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  apps      App[]

  @@map("tenants")
}

model App {
  id                          String        @id @default(cuid())
  tenantId                    String?
  organizationId              String?       // New field for organization relationship
  name                        String
  domain                      String
  corsOrigins                 String[]      @default([])
  redirectUrl                 String
  policyJson                  Json
  emailTemplates              Json?
  metadata                    Json?         // Product waitlists config and other metadata
  isActive                    Boolean       @default(true)
  publicKey                   String?       @unique
  createdAt                   DateTime      @default(now())
  updatedAt                   DateTime      @updatedAt
  autoInviteEnabled           Boolean       @default(false)
  dailyInviteQuota            Int           @default(10)
  inviteTime                  String        @default("09:00")
  masterReferralCode          String?       @unique
  masterReferralCredits       Int           @default(10)
  waitlistEnabled             Boolean       @default(false)
  waitlistEnabledAt           DateTime?
  waitlistMessages            String[]      @default([])
  waitlistLayout              String        @default("centered")
  description                 String?
  logoUrl                     String?
  primaryColor                String?
  backgroundColor             String?
  cardBackgroundColor         String?
  hideGrowthKitBranding       Boolean       @default(false)
  trackUsdValue               Boolean       @default(false)
  allowCustomCredits          Boolean       @default(true)
  maxCustomCredits            Int           @default(100)
  initialCreditsPerDay        Int           @default(3)
  creditsForName              Int           @default(1)
  creditsForEmail             Int           @default(1)
  creditsForEmailVerification Int           @default(1)
  maxCreditBalance            Int?
  creditsPaused               Boolean       @default(false)
  creditsPausedAt             DateTime?
  apiKeys                     ApiKey[]
  tenant                      Tenant?       @relation(fields: [tenantId], references: [id])
  organization                Organization? @relation(fields: [organizationId], references: [id])
  eventLogs                   EventLog[]
  fingerprints                Fingerprint[]
  leads                       Lead[]
  referrals                   Referral[]
  waitlist                    Waitlist[]
  activities                  Activity[]

  @@index([tenantId])
  @@index([organizationId])
  @@index([domain])
  @@map("apps")
}

model ApiKey {
  id         String    @id @default(cuid())
  appId      String
  keyHint    String
  hashedKey  String
  scope      String    @default("full")
  isActive   Boolean   @default(true)
  expiresAt  DateTime?
  lastUsedAt DateTime?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  name       String    @default("API Key")
  app        App       @relation(fields: [appId], references: [id], onDelete: Cascade)

  @@index([appId])
  @@index([keyHint])
  @@map("api_keys")
}

model Fingerprint {
  id             String     @id @default(cuid())
  appId          String
  fingerprint    String
  referralCode   String?    @unique
  createdAt      DateTime   @default(now())
  updatedAt      DateTime   @updatedAt
  lastDailyGrant DateTime?
  lastActiveAt   DateTime?
  browser        String?
  device         String?
  location       Json?
  credits        Credit[]
  app            App        @relation(fields: [appId], references: [id], onDelete: Cascade)
  leads          Lead[]
  referredBy     Referral?  @relation("Referred")
  referrals      Referral[] @relation("Referrer")
  usage          Usage[]
  activities     Activity[]

  @@unique([appId, fingerprint])
  @@index([appId])
  @@index([fingerprint])
  @@index([referralCode])
  @@map("fingerprints")
}

model Credit {
  id            String      @id @default(cuid())
  fingerprintId String
  amount        Int
  reason        String
  metadata      Json?
  createdAt     DateTime    @default(now())
  fingerprint   Fingerprint @relation(fields: [fingerprintId], references: [id], onDelete: Cascade)

  @@index([fingerprintId])
  @@index([reason])
  @@index([createdAt])
  @@map("credits")
}

model Usage {
  id            String      @id @default(cuid())
  fingerprintId String
  action        String
  metadata      Json?
  createdAt     DateTime    @default(now())
  usdValue      Decimal?    @db.Decimal(10, 2)
  fingerprint   Fingerprint @relation(fields: [fingerprintId], references: [id], onDelete: Cascade)

  @@index([fingerprintId])
  @@index([action])
  @@index([usdValue])
  @@index([createdAt])
  @@map("usage")
}

model Referral {
  id             String       @id @default(cuid())
  appId          String
  referrerId     String
  referredId     String?      @unique
  claimToken     String?      @unique
  claimExpiresAt DateTime?
  visitCount     Int          @default(0)
  lastVisitAt    DateTime?
  claimedAt      DateTime?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  app            App          @relation(fields: [appId], references: [id], onDelete: Cascade)
  referred       Fingerprint? @relation("Referred", fields: [referredId], references: [id])
  referrer       Fingerprint  @relation("Referrer", fields: [referrerId], references: [id], onDelete: Cascade)

  @@index([appId])
  @@index([referrerId])
  @@index([referredId])
  @@index([claimToken])
  @@map("referrals")
}

model Lead {
  id              String       @id @default(cuid())
  appId           String
  fingerprintId   String?
  name            String?
  email           String?
  emailVerified   Boolean      @default(false)
  verifyToken     String?      @unique
  verifyExpiresAt DateTime?
  metadata        Json?
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  app             App          @relation(fields: [appId], references: [id], onDelete: Cascade)
  fingerprint     Fingerprint? @relation(fields: [fingerprintId], references: [id])

  @@unique([appId, email])
  @@unique([appId, fingerprintId])
  @@index([appId])
  @@index([fingerprintId])
  @@index([email])
  @@index([verifyToken])
  @@map("leads")
}

model Waitlist {
  id              String    @id @default(cuid())
  appId           String
  email           String
  productTag      String?   // Product identifier for product-specific waitlists (null = app-level)
  status          String    @default("WAITING")
  position        Int?
  invitedAt       DateTime?
  acceptedAt      DateTime?
  metadata        Json?     // Custom field responses stored here
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  convertedAt     DateTime?
  invitationEmail String?
  invitedVia      String?
  codeExpiresAt   DateTime?
  codeUsedAt      DateTime?
  fingerprintId   String?
  invitationCode  String?
  maxUses         Int       @default(1)
  useCount        Int       @default(0)
  app             App       @relation(fields: [appId], references: [id], onDelete: Cascade)

  @@unique([appId, email, productTag])
  @@unique([appId, invitationCode])
  @@index([appId])
  @@index([appId, productTag])
  @@index([status])
  @@index([position])
  @@index([invitationCode])
  @@index([fingerprintId])
  @@map("waitlist")
}

model EventLog {
  id         String   @id @default(cuid())
  appId      String
  event      String
  entityType String?
  entityId   String?
  metadata   Json?
  ipAddress  String?
  userAgent  String?
  createdAt  DateTime @default(now())
  app        App      @relation(fields: [appId], references: [id], onDelete: Cascade)

  @@index([appId])
  @@index([event])
  @@index([entityType, entityId])
  @@index([createdAt])
  @@map("event_logs")
}

model Activity {
  id            String   @id @default(cuid())
  appId         String
  fingerprintId String
  eventName     String
  properties    Json?
  context       Json
  sessionId     String
  timestamp     DateTime @default(now())

  app         App         @relation(fields: [appId], references: [id], onDelete: Cascade)
  fingerprint Fingerprint @relation(fields: [fingerprintId], references: [id], onDelete: Cascade)

  @@index([appId, timestamp])
  @@index([fingerprintId, timestamp])
  @@index([appId, eventName])
  @@map("activities")
}

model AdminActivity {
  id         String   @id @default(cuid())
  action     String // e.g., "app_created", "user_paused", "credits_issued"
  targetType String? // e.g., "app", "user", "waitlist"
  targetId   String? // ID of the affected entity
  metadata   Json? // Additional context
  timestamp  DateTime @default(now())

  @@index([action])
  @@index([targetType, targetId])
  @@index([timestamp])
  @@map("admin_activities")
}

model OrganizationCreditTransaction {
  id             String       @id @default(cuid())
  organizationId String
  amount         Int          // positive for add, negative for spend
  type           String       // "ADMIN_ADD", "EMAIL_SEND", "FEATURE_USE", etc.
  description    String?      // optional human-readable note
  createdAt      DateTime     @default(now())
  
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  @@index([organizationId, createdAt])
  @@map("organization_credit_transactions")
}
