var r;function w(e){let c=e.referralPath||"/r",t=e.redirectTo||"/";return async function(i,f){r||(r=(await import("next/server")).NextResponse);let s=i.nextUrl.pathname;if(s==="/verify"){let o=i.nextUrl.searchParams.get("token");if(!o){e.debug&&console.warn("[GrowthKit] Missing verification token");let n=new URL(t,i.url);return n.searchParams.set("verified","false"),n.searchParams.set("error","missing-token"),r.redirect(n)}e.debug&&console.log("[GrowthKit] Processing email verification with token");try{let n=await fetch(`${e.apiUrl}/v1/verify/email`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e.apiKey}`},body:JSON.stringify({token:o})}),a=new URL(t,i.url);return n.ok?(e.debug&&console.log("[GrowthKit] Email verified successfully"),a.searchParams.set("verified","true")):(e.debug&&console.error("[GrowthKit] Email verification failed:",n.status),a.searchParams.set("verified","false")),r.redirect(a)}catch(n){e.debug&&console.error("[GrowthKit] Error verifying email:",n);let a=new URL(t,i.url);return a.searchParams.set("verified","false"),a.searchParams.set("error","verification-failed"),r.redirect(a)}}if(s.startsWith("/invite/")){let o=s.slice(8).split("/")[0];if(!o)return e.debug&&console.warn("[GrowthKit] No invitation code found in path:",s),r.redirect(new URL(t,i.url));e.debug&&console.log("[GrowthKit] Processing invitation code:",o);let n=new URL(t,i.url);return n.searchParams.set("ref",o),e.debug&&console.log("[GrowthKit] Redirecting with invitation code to:",n.toString()),r.redirect(n)}if(!s.startsWith(c+"/"))return r.next();let d=s.slice(c.length+1).split("/")[0];if(!d)return e.debug&&console.warn("[GrowthKit] No referral code found in path:",s),r.redirect(new URL(t,i.url));e.debug&&console.log("[GrowthKit] Processing referral code:",d);try{let o=await fetch(`${e.apiUrl}/v1/referral/exchange`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e.apiKey}`},body:JSON.stringify({referralCode:d})});if(!o.ok)return e.debug&&console.error("[GrowthKit] Failed to exchange referral code:",o.status),r.redirect(new URL(t,i.url));let a=(await o.json()).data?.claim;if(!a)return e.debug&&console.error("[GrowthKit] No claim token received from exchange"),r.redirect(new URL(t,i.url));let h=new URL(t,i.url);return h.searchParams.set("ref",a),e.debug&&console.log("[GrowthKit] Redirecting with claim token to:",h.toString()),r.redirect(h)}catch(o){return e.debug&&console.error("[GrowthKit] Error processing referral:",o),r.redirect(new URL(t,i.url))}}}async function u(e,c){let t=process.env.GROWTHKIT_API_KEY,l=process.env.GROWTHKIT_API_URL;return!t||!l?(console.error("[GrowthKit] GROWTHKIT_API_KEY and GROWTHKIT_API_URL environment variables are required"),r||(r=(await import("next/server")).NextResponse),r.next()):w({apiKey:t,apiUrl:l,debug:process.env.NODE_ENV==="development"})(e,c)}export{w as createGrowthKitMiddleware,u as growthKitMiddleware};
//# sourceMappingURL=middleware.mjs.map