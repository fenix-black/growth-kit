"use strict";var m=Object.create;var d=Object.defineProperty;var g=Object.getOwnPropertyDescriptor;var K=Object.getOwnPropertyNames;var R=Object.getPrototypeOf,x=Object.prototype.hasOwnProperty;var y=(e,i)=>{for(var r in i)d(e,r,{get:i[r],enumerable:!0})},w=(e,i,r,l)=>{if(i&&typeof i=="object"||typeof i=="function")for(let t of K(i))!x.call(e,t)&&t!==r&&d(e,t,{get:()=>i[t],enumerable:!(l=g(i,t))||l.enumerable});return e};var u=(e,i,r)=>(r=e!=null?m(R(e)):{},w(i||!e||!e.__esModule?d(r,"default",{value:e,enumerable:!0}):r,e)),P=e=>w(d({},"__esModule",{value:!0}),e);var G={};y(G,{createGrowthKitMiddleware:()=>p,growthKitMiddleware:()=>U});module.exports=P(G);var o;function p(e){let i=e.referralPath||"/r",r=e.redirectTo||"/";return async function(t,v){o||(o=(await import("next/server")).NextResponse);let c=t.nextUrl.pathname;if(c==="/verify"){let n=t.nextUrl.searchParams.get("token");if(!n){e.debug&&console.warn("[GrowthKit] Missing verification token");let a=new URL(r,t.url);return a.searchParams.set("verified","false"),a.searchParams.set("error","missing-token"),o.redirect(a)}e.debug&&console.log("[GrowthKit] Processing email verification with token");try{let a=await fetch(`${e.apiUrl}/v1/verify/email`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e.apiKey}`},body:JSON.stringify({token:n})}),s=new URL(r,t.url);return a.ok?(e.debug&&console.log("[GrowthKit] Email verified successfully"),s.searchParams.set("verified","true")):(e.debug&&console.error("[GrowthKit] Email verification failed:",a.status),s.searchParams.set("verified","false")),o.redirect(s)}catch(a){e.debug&&console.error("[GrowthKit] Error verifying email:",a);let s=new URL(r,t.url);return s.searchParams.set("verified","false"),s.searchParams.set("error","verification-failed"),o.redirect(s)}}if(c.startsWith("/invite/")){let n=c.slice(8).split("/")[0];if(!n)return e.debug&&console.warn("[GrowthKit] No invitation code found in path:",c),o.redirect(new URL(r,t.url));e.debug&&console.log("[GrowthKit] Processing invitation code:",n);let a=new URL(r,t.url);return a.searchParams.set("ref",n),e.debug&&console.log("[GrowthKit] Redirecting with invitation code to:",a.toString()),o.redirect(a)}if(!c.startsWith(i+"/"))return o.next();let h=c.slice(i.length+1).split("/")[0];if(!h)return e.debug&&console.warn("[GrowthKit] No referral code found in path:",c),o.redirect(new URL(r,t.url));e.debug&&console.log("[GrowthKit] Processing referral code:",h);try{let n=await fetch(`${e.apiUrl}/v1/referral/exchange`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e.apiKey}`},body:JSON.stringify({referralCode:h})});if(!n.ok)return e.debug&&console.error("[GrowthKit] Failed to exchange referral code:",n.status),o.redirect(new URL(r,t.url));let s=(await n.json()).data?.claim;if(!s)return e.debug&&console.error("[GrowthKit] No claim token received from exchange"),o.redirect(new URL(r,t.url));let f=new URL(r,t.url);return f.searchParams.set("ref",s),e.debug&&console.log("[GrowthKit] Redirecting with claim token to:",f.toString()),o.redirect(f)}catch(n){return e.debug&&console.error("[GrowthKit] Error processing referral:",n),o.redirect(new URL(r,t.url))}}}async function U(e,i){let r=process.env.GROWTHKIT_API_KEY,l=process.env.GROWTHKIT_API_URL;return!r||!l?(console.error("[GrowthKit] GROWTHKIT_API_KEY and GROWTHKIT_API_URL environment variables are required"),o||(o=(await import("next/server")).NextResponse),o.next()):p({apiKey:r,apiUrl:l,debug:process.env.NODE_ENV==="development"})(e,i)}0&&(module.exports={createGrowthKitMiddleware,growthKitMiddleware});
//# sourceMappingURL=middleware.js.map